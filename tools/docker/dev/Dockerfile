ARG BASE_REPO="registry.redhat.io"
ARG BASE_IMAGE="ubi9/ubi"
ARG BASE_TAG="9.7"

################################################
FROM $BASE_REPO/$BASE_IMAGE:$BASE_TAG AS base

# Provide your own RHEL subscription
RUN --mount=type=secret,id=RHEL_ORG \
  --mount=type=secret,id=RHEL_ACTIVATION_KEY \
  subscription-manager register \
  --org=$(cat /run/secrets/RHEL_ORG) \
  --activationkey=$(cat /run/secrets/RHEL_ACTIVATION_KEY)

################################################
FROM base AS setup

# Install tools
#
# iputils for ping
# sudo for non-root user sudo support
# vim-enhanced for color vi support in git
# wget to install vscode server
#
RUN dnf update -y \
  && dnf -y install \
  git \
  iputils \
  sudo \
  vim-enhanced \
  wget \
  && dnf clean all \
  && rm -rf /var/cache/yum

# Install root user .bashrc
RUN --mount=type=bind,source=user.bashrc,target=user.bashrc \
  cat user.bashrc >> /root/.bashrc

# üõÇ Create the non-root (developer) user
ARG USERNAME
ARG USER_UID=1000
ARG USER_GID=$USER_UID

# Create the user
#
# Note, most of our usernames use the `first.last` template. Having a `.` in a
# username is POSIX compliant (good). However, `sudoers.d` ignores any file
# containing a `.` as a way to disable changes; so files named `first.last` are
# simply ignored. Instead, use the `USER_UID` as the file name.
# See https://superuser.com/a/869145
#
RUN groupadd --gid $USER_GID $USERNAME \
  && useradd -s /bin/bash --uid $USER_UID --gid $USER_GID -m $USERNAME \
  && echo $USERNAME ALL=\(ALL\) NOPASSWD: ALL > /etc/sudoers.d/$USER_UID \
  && chmod 0440 /etc/sudoers.d/$USER_UID

################################################
FROM setup AS build-env

# Specify as the default user in the WSL config
RUN printf "\n[user]\ndefault = $USERNAME\n" >> /etc/wsl.conf

# Install the .bashrc for the user
WORKDIR /home/$USERNAME/.bashrc.d
COPY --chown=$USER_UID:$USER_GID user.bashrc .
COPY --chown=$USER_UID:$USER_GID git.bashrc .

# üîÄ Copy user-specific git configuration
#
# Copy the global user config generated by the build script and added to the
# docker build contex.
#
WORKDIR /home/$USERNAME
COPY --chown=$USER_UID:$USER_GID .gitconfig .

# üßë‚Äçüíª Change to non-root user
USER $USERNAME

# üßë‚Äçüíª Set user global configuration, in `$HOME/.gitconfig`.

# Setup Git Credential Manager
# This works for developing on windows host workstations.
#
# See https://learn.microsoft.com/en-us/windows/wsl/tutorials/wsl-git#git-credential-manager-setup
#
RUN git config --global credential.helper \
  "/mnt/c/Program\ Files/Git/mingw64/bin/git-credential-manager.exe"

RUN \
  # Never enable autocrlf
  git config --global core.autocrlf false \
  # Explicity specify the default eol to `LF`
  && git config --global core.eol lf \
  # Always rebase on pull operations, never merge.
  && git config --global pull.rebase true \
  # `fetch` will always run prune, so you never need to
  && git config --global remote.origin.prune true \
  # Adds color when showing blocks of code that moved by remain unchanged
  && git config --global diff.colorMoved dimmed-zebra \
  # Set vim as the default editor. Modify as desired.
  && git config --global core.editor vim \
  # Configure `main` as default branch
  && git config --global init.defaultBranch main

CMD [ "bash" ]

################################################
# Install K8s tools
# see https://kubernetes.io/docs/tasks/tools/
#
FROM build-env AS k8s-env

USER root

# Install kubectl
# see https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/
RUN curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl" \
  && curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl.sha256" \
  && echo "$(cat kubectl.sha256)  kubectl" | sha256sum --check \
  && install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl \
  && kubectl version --client

# Install kind
# see https://kind.sigs.k8s.io/
RUN curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.30.0/kind-linux-amd64 \
  && chmod +x ./kind \
  && mv ./kind /usr/local/bin/kind

# Install minikube
RUN curl -LO https://github.com/kubernetes/minikube/releases/latest/download/minikube-linux-amd64 \
  && install minikube-linux-amd64 /usr/local/bin/minikube \
  && rm minikube-linux-amd64

USER $USERNAME
